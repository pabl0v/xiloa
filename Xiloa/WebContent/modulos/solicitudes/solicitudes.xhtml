<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:sec="http://www.springframework.org/security/tags">
    <h:head>
	<link type="text/css" rel="stylesheet" href="../../resources/css/solicitudes.css"></link>
    </h:head>
    <h:body>
 
    <div id="contenedor">
    	<div id="header">
            <ui:insert name="header" >
                <ui:include src="../../modulos/compartido/paginamaestra.xhtml" />
	    	</ui:insert>
	    	 <script type="text/javascript" src="../../resources/scripts/solicitudes.js"></script>
		</div>	
		<h:form id="formSolicitudes">
        <div id="cabezera">
            <h2>Gestión de Solicitudes</h2>
            <sec:authorize ifAnyGranted="ROLE_RIGHT_CREAR_SOLICITUDES">                  
            <div id="botones_filtro_contenedor">                 
                <div class="botones_filtro" onclick="window.location='/Xiloa/modulos/solicitudes/registro_solicitud.xhtml'"  >
                	<p class="icono_nuevo">Nueva solicitud</p>
                </div>                           
                <div class="botones_filtro">
                	<p class="icono_exportar"></p>
                	<h:commandLink style="margin-bottom: 5px" >  
            			<h:outputText value="Descargar" />   
            			<p:dataExporter type="xls" target="dtSolicitud" fileName="ReporteSolicitudes" />           		
        			</h:commandLink>
        		</div>                
            </div>
            </sec:authorize>
       </div>
		<div id="contenedor_filtro">
				<p:splitButton id="accionSplit" value="Acción" icon="ui-icon-pencil" title="Acción a Realizar" style="display:inline-block;"  update=":formSolicitudes:dtSolicitud" >   
	        		<p:separator />
	        		<sec:authorize ifAnyGranted="ROLE_RIGHT_CREAR_SOLICITUDES">
						<p:menuitem value="Enviar Solicitud" title="Enviar Solicitud" action="#{dashBoardSolicitudesManagedBean.enviarSolicitud(dashBoardSolicitudesManagedBean.selectedSolicitud)}" update=":formSolicitudes" />
					</sec:authorize>
                	<sec:authorize ifAnyGranted="ROLE_RIGHT_EDITAR_PORTAFOLIO">                  
		            	<p:menuitem value="Editar Solicitud" title="Editar Solicitud" action="#{dashBoardSolicitudesManagedBean.editaSolicitud(dashBoardSolicitudesManagedBean.selectedSolicitud)}" disabled="#{!varSolicitudI.editable}" />
    				</sec:authorize>        	 		
	        	 	<sec:authorize ifAnyGranted="ROLE_RIGHT_SELECCION">
	       		 		<p:menuitem value="Autorizar Matricula" title="Autorizar Matricula" style="display:inline-block;" action="#{dashBoardSolicitudesManagedBean.autorizarMatricula(dashBoardSolicitudesManagedBean.selectedSolicitud)}" update=":formSolicitudes"  />
	       		 	</sec:authorize>
	       		 	<sec:authorize ifAnyGranted="ROLE_RIGHT_SELECCION">
	       		 		<p:menuitem value="Rechazar Solicitud" title="Rechazar Solicitud" style="display:inline-block;" action="#{dashBoardSolicitudesManagedBean.actualizarEstadoSolicitud(dashBoardSolicitudesManagedBean.selectedSolicitud,3)}" update=":formSolicitudes"  />
	       		 	</sec:authorize>
	       		 	<sec:authorize ifAnyGranted="ROLE_RIGHT_SELECCION">
	       		 		<p:menuitem value="Matricular Candidato" title="Matricular Candidato" style="display:inline-block;" onclick="PF('dlg1').show();" update=":matriculaForm" />
	       		 	</sec:authorize>
	       		 	<sec:authorize ifAnyGranted="ROLE_RIGHT_VER_CONVOCATORIA">
	       		 		<p:menuitem value="Convocar Candidato" title="Convocar Candidato" style="display:inline-block;" onclick="PF('dlg2').show();" update=":convocatoriaForm, :convocatoriaDataTableForm"  />
	       		 	</sec:authorize>
	       		 	<sec:authorize ifAnyGranted="ROLE_RIGHT_VER_EVALUACIONES">
						<p:menuitem value="Evaluar Candidato" title="Evaluar Candidato" style="display:inline-block;" action="#{dashBoardSolicitudesManagedBean.evaluarSolicitud(dashBoardSolicitudesManagedBean.selectedSolicitud)}" />
					</sec:authorize>
					<sec:authorize ifAnyGranted="ROLE_RIGHT_CREAR_SOLICITUDES">	       		 		
						<p:menuitem value="Anular Solicitud" title="Anular Solicitud" style="display:inline-block;" action="#{dashBoardSolicitudesManagedBean.actualizarEstadoSolicitud(dashBoardSolicitudesManagedBean.selectedSolicitud,10)}" update=":formSolicitudes:dtSolicitud" disabled="#{!varSolicitudI.erasable}" />
					</sec:authorize>
	   				</p:splitButton>
			<p:splitButton id="reportesSplit" value="Reportes" icon="ui-icon-print" title="Reportes del Candidato" style="display:inline-block;" action="#{dashBoardSolicitudesManagedBean.runSolicitudCandidato}"  update=":formSolicitudes:msgSolicitudes" >   
				<p:separator />         		   
				<p:menuitem value="Pre-Matricula" icon="ui-icon-print" title="Generar Formato Pre-Matricula" style="display:inline-block;" action="#{dashBoardSolicitudesManagedBean.runPreMatricula}" update=":formSolicitudes:msgSolicitudes"  />			       		         	   	       			     			       			  
			</p:splitButton>
		</div>
        <div id="contenedor_tabla_solicitudes">     
        	<p:messages id="msgSolicitudes" showDetail="true" autoUpdate="false" closable="true" />        	      
        	<p:dataTable id="dtSolicitud" widgetVar="dtSolicitudes" emptyMessage="No existen solicitudes activas" var="varSolicitudI" value="#{dashBoardSolicitudesManagedBean.listaSolicitudes}" selectionMode="single" rowKey="#{varSolicitudI.id}" paginator="true" rows="12"  >
				<p:ajax event="rowSelect" listener="#{dashBoardSolicitudesManagedBean.onRowSelect}" />
				<p:ajax event="rowUnselect" listener="#{dashBoardSolicitudesManagedBean.onRowUnselect}"/>
				<!--Las columnas de la tabla-->
                <p:column id="expedienteColumn" exportable="true">
                	<f:facet name="header">  
            			<h:outputText value="Id" />
        			</f:facet> 
                	<h:outputText value="#{varSolicitudI.id}" />
                </p:column>
                <p:column id="centroColumn" exportable="true" filterBy="#{varSolicitudI.certificacion.ifpNombre}" filterOptions="#{dashBoardSolicitudesManagedBean.listaCentros}" filterMatchMode="exact">
                	<f:facet name="header">  
            			<h:outputText value="Centro Evaluador" />
        			</f:facet> 
                	<h:outputText value="#{varSolicitudI.certificacion.ifpNombre}" />
                </p:column>                      
                <p:column id="candidatoColumn" exportable="true" filterBy="#{varSolicitudI.contacto.nombreCompleto}"  filterMatchMode="contains">
                	<f:facet name="header">  
            			<h:outputText value="Candidato" />  
        			</f:facet> 
                	<h:outputText value="#{varSolicitudI.contacto.nombreCompleto}" />
                 </p:column>  
                <p:column id="certificacionColumn" exportable="true" filterBy="#{varSolicitudI.certificacion.nombre}" filterMatchMode="contains">
                	<f:facet name="header">  
            			<h:outputText value="Certificación" />  
        			</f:facet> 
                	<h:outputText value="#{varSolicitudI.certificacion.nombre}"/>
                </p:column>  
                <p:column id="fechaColumn" exportable="true">
                	<f:facet name="header">  
            			<h:outputText value="Fecha Solicitud" />  
        			</f:facet> 
                	<h:outputText value="#{varSolicitudI.fechaRegistro}" >
                		<f:convertDateTime type="date" pattern="dd/MM/yyyy"/>
                	</h:outputText>
                </p:column>               
                <p:column id="estadoColumn" exportable="true" filterBy="#{varSolicitudI.estatus.valor}" filterOptions="#{dashBoardSolicitudesManagedBean.listaEstatus}" filterMatchMode="exact">
                	<f:facet name="header">
            			<h:outputText value="Estado" />  
        			</f:facet>
                	<h:outputText value="#{varSolicitudI.estatus.valor}" />
                </p:column>
            </p:dataTable>
        </div>
     </h:form>
    </div>
	<p:dialog id="modalMatricula" styleClass="estilo_dialogoactividades" header="Registro de Matricula:" widgetVar="dlg1" modal="true" resizable="false" width="480" height="150">
		<h:form id="matriculaForm">
			<br/>
			<br/>
			<h:panelGrid id="modal1" columns="3" cellpadding="15" cellspacing="10" >
            	<h:outputLabel styleClass="estilo_label" value="Fecha de Matricula:" />
				<p:calendar id="codigo1" value="#{dashBoardSolicitudesManagedBean.selectedSolicitud.fechaMatricula}" showOn="button" pattern="dd/MM/yyyy" mindate="01/06/2014" maxdate="31/12/2014" required="true" requiredMessage="Fecha requerida" validatorMessage="Fecha invalida" />
            	<p:message for="codigo1" display="text"  />		
            	<h:outputLabel styleClass="estilo_label" value="Número de Recibo:" />
            	<p:inputText id="codigo2" value="#{dashBoardSolicitudesManagedBean.selectedSolicitud.reciboMatricula}" required="true" requiredMessage="Recibo requerido" />
            	<p:message for="codigo2" display="text"  />
			</h:panelGrid>
			<div class="contenedor_botones" style="margin-top:32px;">
				<p:commandButton value="Cancelar" onclick="PF('dlg1').hide();" immediate="true" update=":matriculaForm" /> 
				<p:commandButton value="Aceptar" oncomplete="if(!args.validationFailed) {dlg1.hide()} else {dlg1.show()}" update=":matriculaForm,:formSolicitudes" action="#{dashBoardSolicitudesManagedBean.registrarMatricula(dashBoardSolicitudesManagedBean.selectedSolicitud.fechaMatricula,dashBoardSolicitudesManagedBean.selectedSolicitud.reciboMatricula)}" />
			</div>
		</h:form>
	</p:dialog>
	<p:dialog id="modalConvocatoria" header="Registro de Convocatorias:" widgetVar="dlg2" modal="true" resizable="false" width="700" height="480">
		<h:form id="convocatoriaForm">
			<br/>
			<p:inputText rendered="false" value="#{dashBoardSolicitudesManagedBean.selectedConvocatoria.id}" />
			<h:panelGrid id="modal2" columns="3" cellpadding="15" cellspacing="10" >
            	<h:outputLabel value="Fecha/Hora:" />
            	<p:calendar id="codigo3" size="30" value="#{dashBoardSolicitudesManagedBean.selectedConvocatoria.fecha}" showOn="button" pattern="dd/MM/yyyy hh:mm a" mindate="01/06/2014" disabledWeekends="true" minHour="8" maxHour="17" required="true" requiredMessage="La fecha es requerida" validatorMessage="Fecha invalida" />
            	<p:message for="codigo3" display="text"  />
				<h:outputLabel value="Actividad:" />
				<p:selectOneMenu id="selector_estatus1" style="width:100%;" required="true" requiredMessage="Seleccione la actividad" styleClass="selector_status_estilo" value="#{dashBoardSolicitudesManagedBean.selectedConvocatoria.actividadId}" >  
					<f:selectItem itemLabel="Seleccione..." itemValue="" noSelectionOption="true" />
					<f:selectItems value="#{dashBoardSolicitudesManagedBean.actividades}" var="actividad" itemLabel="#{actividad.descripcion}" itemValue="#{actividad.id}" />
					<p:ajax update="selector_estatus2" event="change" listener="#{dashBoardSolicitudesManagedBean.handleActividadesChange}" />
				</p:selectOneMenu>
				<p:message for="selector_estatus1" display="text" />
				<h:outputLabel value="Responsable:" />
				<p:selectOneMenu id="selector_estatus2" style="width:100%;" required="true" requiredMessage="Seleccione al involucrado" styleClass="selector_status_estilo" value="#{dashBoardSolicitudesManagedBean.selectedConvocatoria.contactoId}" >  
					<f:selectItem itemLabel="Seleccione..." itemValue="" noSelectionOption="true" />
					<f:selectItems value="#{dashBoardSolicitudesManagedBean.involucrados}" var="involucrado" itemLabel="#{involucrado.descripcion}" itemValue="#{involucrado.id}" />
				</p:selectOneMenu>
				<p:message for="selector_estatus2" display="text" />
				<h:outputLabel value="Estado:" />
				<p:selectOneMenu id="selector_estatus3" style="width:100%;" required="true" requiredMessage="Seleccione el estado" styleClass="selector_status_estilo" value="#{dashBoardSolicitudesManagedBean.selectedConvocatoria.estadoId}" >  
					<f:selectItem itemLabel="Seleccione..." itemValue="" noSelectionOption="true" />
					<f:selectItems value="#{dashBoardSolicitudesManagedBean.estados}" var="estado" itemLabel="#{estado.valor}" itemValue="#{estado.id}" />
				</p:selectOneMenu>
				<p:message for="selector_estatus3" display="text" />
			</h:panelGrid>
			<div class="contenedor_botones" style="margin-top:32px;">
				<sec:authorize ifAnyGranted="ROLE_RIGHT_EDITAR_CONVOCATORIA">
					<p:commandButton value="Nuevo" style="width:80px;height:30px" update=":convocatoriaForm" action="#{dashBoardSolicitudesManagedBean.nuevaConvocatoria}" />
					<p:commandButton value="Aceptar" style="width:80px;height:30px" oncomplete="if(args.validationFailed) {dlg2.show()}" update=":convocatoriaForm, :convocatoriaDataTableForm" action="#{dashBoardSolicitudesManagedBean.registrarConvocatoria(dashBoardSolicitudesManagedBean.selectedConvocatoria)}" />
				</sec:authorize>
			</div>
		</h:form>
			<br/>
		<h:form id="convocatoriaDataTableForm">
			<p:dataTable id="convocatoriasDataTable" paginatorPosition="bottom" emptyMessage="No hay datos para mostrar" var="convocatoria" value="#{dashBoardSolicitudesManagedBean.convocatorias}" paginator="true" rows="5" rowKey="#{convocatoria.id}" selectionMode="single" selection="#{dashBoardSolicitudesManagedBean.selectedConvocatoria}">
				<p:ajax event="rowSelect" update=":convocatoriaForm" />
				<p:column headerText="Convocatoria"><h:outputText value="#{convocatoria.actividadNombre}" /></p:column>
				<p:column headerText="Fecha/Hora"><h:outputText value="#{convocatoria.fecha}" ><f:convertDateTime type="date" pattern="dd/MM/yyyy hh:mm a"/></h:outputText></p:column>
				<p:column headerText="Responsable"><h:outputText value="#{convocatoria.contactoNombre}" /></p:column>
				<p:column headerText="Estado"><h:outputText value="#{convocatoria.estadoNombre}" /></p:column>
			</p:dataTable>
			<div class="contenedor_botones" style="margin-top:32px;">
				<p:commandButton value="Cerrar" style="width:80px;height:30px" update=":formSolicitudes:dtSolicitud" onclick="PF('dlg2').hide();" immediate="true" /> 
			</div>
		</h:form>
	</p:dialog>
	<p:dialog id="modalSolicitud" header="Registro de Solicitud:" widgetVar="dlg3" modal="true" resizable="false" width="550" height="500">
		<h:form id="solicitudForm">
			<h:panelGrid id="modal3" columns="3" cellpadding="15" cellspacing="10" >
                <h:outputLabel for="primerNombre" value="Primer nombre (*):" /> 
                <p:inputText id="primerNombre" value="#{dashBoardSolicitudesManagedBean.solicitante.primerNombre}" required="true" requiredMessage="Campo obligatorio" />
                <p:message for="primerNombre" display="text" />
                <h:outputLabel value="Segundo nombre:" /> 
                <p:inputText for="segundoNombre" id="segundoNombre" value="#{dashBoardSolicitudesManagedBean.solicitante.segundoNombre}" required="false" />
				<p:message for="segundoNombre" display="text" />
                <h:outputLabel for="primerApellido" value="Primer apellido (*):" /> 
                <p:inputText id="primerApellido" value="#{dashBoardSolicitudesManagedBean.solicitante.primerApellido}" required="true" requiredMessage="Campo obligatorio" />
                <p:message for="primerApellido" display="text" />
                <h:outputLabel for="segundoApellido" value="Segundo apellido:" /> 
                <p:inputText id="segundoApellido" value="#{dashBoardSolicitudesManagedBean.solicitante.segundoApellido}" required="false" requiredMessage="Campo obligatorio" />
                <p:message for="segundoApellido" display="text" />
                <h:outputLabel for="numeroIdentificacion" value="Cedula (*):" />
                <p:inputMask id="numeroIdentificacion" value="#{dashBoearSolicitudesManagedBean.solicitante.numeroIdentificacion}" required="true" requiredMessage="Campo obligatorio" mask="999-999999-9999a"/>
                <p:message for="numeroIdentificacion" display="text" />
		        <h:outputText for="ckTrabaja" value="Trabaja actualmente? (*): " />  
		        <p:selectBooleanCheckbox id="ckTrabaja" value="#{dashBoardSolicitudesManagedBean.solicitud.situacion_laboral}" />
				<p:message for="ckTrabaja" display="text" />
                <h:outputLabel for="descEmpresaLabora" value="Empresa:" />  
                <p:inputText id="descEmpresaLabora" value="#{dashBoardSolicitudesManagedBean.solicitud.empresa}" />  
                <p:message for="descEmpresaLabora" display="text" />
                <h:outputLabel for="experiencia" value="Años de experiencia?:" required="false" />  
                <p:inputText id="experiencia" value="#{dashBoearSolicitudesManagedBean.solicitud.experiencia}" />
                <p:message for="experiencia" display="text" />
                <h:outputLabel for="ocupacion" value="Ocupación actual:" />
				<p:inputText id="ocupacion" value="#{dashBoardSolicitudesManagedBean.solicitud.ocupacion}" required="false" />				
				<p:message for="ocupacion" display="text" />
			</h:panelGrid>
			<div class="contenedor_botones" style="margin-top:32px;">
				<p:commandButton value="Cancelar" style="width:80px;height:30px" onclick="PF('dlg3').hide();" immediate="true" />
				<p:commandButton value="Aceptar" style="width:80px;height:30px" oncomplete="if(!args.validationFailed) {dlg3.hide()} else {dlg3.show()}" action="#{dashBoardSolicitudesManagedBean.registrarSolicitud(dashBoardSolicitudesManagedBean.solicitud,dashBoardSolicitudesManagedBean.solicitante)}" />
			</div>
		</h:form>
	</p:dialog>
</h:body>
</html>